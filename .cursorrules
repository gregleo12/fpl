# FPL H2H Analytics - Development Rules

## CRITICAL: Read Context First
Before ANY task, read `CLAUDE_CODE_CONTEXT.md` for:
- Past bugs and fixes
- Architecture decisions
- Deployment process
- Testing requirements

## Railway Deployment

### Environments
- **Staging:** `fpl-staging-production.up.railway.app` (branch: `staging`)
  - Auto-deploys on `git push origin staging`
  - OK if it breaks - testing environment
- **Production:** `dedoume.pronos.xyz` (branch: `main`)
  - ‚ö†Ô∏è **REQUIRES GREG'S APPROVAL** before deploying
  - NEVER push to `main` without explicit approval

### Deployment Rules
- ‚úÖ Push to `staging` freely for testing
- ‚ùå NEVER push to `main` without Greg's approval
- üß™ Always test on staging first
- üìà Ask: "Ready to merge staging to main and deploy to production?"

### Database
- PostgreSQL with connection pool (max: 10)
- Internal connection: `postgres.railway.internal`
- Shared across staging and production
- Check Railway logs if 502 errors occur

## Never Touch These
1. `/src/hooks/usePullToRefresh.ts` - Breaks modal scrolling
2. Global event listeners without modal detection
3. Connection strings (use environment variables)

## Always Do These
1. Test locally: `npm run build`
2. Unified calculations (no duplicate logic)
3. Auto-subs BEFORE bonus calculations
4. Bonus only for top 3 BPS PER MATCH (not global)
5. Mobile testing in iOS simulator

## Common Mistakes to Avoid
- Don't create duplicate calculation logic in different files
- Don't forget fixture grouping for bonus (per-match, not per-team)
- Don't modify scores without updating ALL locations (fixture cards + modal + differential)
- Don't assume - verify data structure with console.logs first

## Stats Hub Patterns (v1.11.9-v1.14.0)

### Data Fetching Priority
- ALWAYS fetch from FPL API for accuracy (not database)
- Database may have incomplete/stale data
- Example: Captain points, chips data, bonus points

### Modal Pattern
- Use shared modal component (FullRankingModal.tsx)
- Render function pattern: define once, use in card + modal
- stopPropagation on toggles to prevent modal opening

### Toggle Consistency
- All toggles must use same CSS classes
- Position in cardHeader (not standalone)
- Active state with green highlight

### Captain Points Calculation
- Fetch from FPL API: picks + live data in parallel
- Formula: base_points √ó multiplier
- Get total season points from league_standings for percentage

### Chip Performance
- Two separate leaderboards: Chips Played vs Chips Faced
- Fetch chip history from FPL API per manager
- Chips Faced: query h2h_matches for opponent chips

### Streaks Calculation
- Historical maximum (not current active)
- Track GW range: "GW5 ‚Üí GW11"
- Separate winning and losing streaks
- Order by event ASC for proper tracking

## When Starting New Session
1. Read CLAUDE_CODE_CONTEXT.md
2. Check `git log --oneline -10` for recent changes
3. Review any open issues from last session

## Version Numbering (CRITICAL)
- Major (X.0.0): Breaking changes, redesigns
- Minor (0.X.0): New features, new components
- Patch (0.0.X): Bug fixes, small improvements
- ALWAYS: npm version [type] before git push
- ALWAYS: Include (vX.Y.Z) in commit message
- NEVER: Push without version bump
