# FPL H2H Analytics - Complete Version History

**Project Start:** October 23, 2024
**Total Releases:** 252+ versions
**Current Version:** v2.7.2 (December 16, 2025)

---

## ðŸ—„ï¸ v2.7.x - K-27 Database Caching & Hotfixes (Dec 2025)

### v2.7.2 - Fix Free Transfer Calculation for GW16+ Matches (Dec 16, 2025)
**BUGFIX:** Fixed AFCON special rule incorrectly overwriting FT calculation for all GW16+ matches
- **Problem**: H2H match modal showed "5 FT" for everyone when viewing GW16+ matches
  - Example: Greg had 5 FT for GW16, made 3 transfers, should have 3 FT for GW17
  - Modal showed: 5 FT (incorrect)
  - Expected: 3 FT (5 - 3 + 1 rollover = 3)
- **Root Cause**: AFCON rule logic ran AFTER loop and overwrote calculated FT balance
  - Code checked `if (matchGameweek >= 16)` and unconditionally set `ftBalance = 5`
  - This applied to ALL matches GW16 and later (GW17, GW18, etc.)
  - Ignored transfers already made in GW16
- **Fix**: Moved AFCON rule INSIDE the loop at GW16 start
  - `src/app/api/league/[id]/matches/[matchId]/route.ts:145-148`
  - `src/app/api/league/[id]/insights/[entryId]/route.ts:249-252`
  - Now sets FT = 5 at the START of GW16 processing (before consuming transfers)
  - Normal calculation continues (consumes transfers, adds +1 rollover)
  - Removed post-loop override that was breaking GW17+
- **Testing**:
  - âœ“ Build successful with no TypeScript errors
  - âœ“ Expected results:
    - GW16 with 3 transfers â†’ GW17 shows 3 FT (5 - 3 + 1 = 3)
    - GW16 with 0 transfers â†’ GW17 shows 5 FT (5 - 0 + 1 = 6, capped at 5)
    - GW16 with 5 transfers â†’ GW17 shows 1 FT (5 - 5 + 1 = 1)
- **Files Changed**:
  - `src/app/api/league/[id]/matches/[matchId]/route.ts` (primary match endpoint)
  - `src/app/api/league/[id]/insights/[entryId]/route.ts` (insights endpoint)
- **Impact**: Correct FT display for all managers in H2H match modals

### v2.7.1 - Fix H2H Fixtures Showing 0-0 for Completed GWs (Dec 16, 2025)
**HOTFIX:** Fixed critical regression in v2.7.0 where all completed GW fixtures displayed 0-0
- **Problem**: H2H Fixtures tab showed all matches as 0-0, but match modals showed correct scores
- **Root Cause**: `scoreCalculator.ts` was incomplete when fetching from database for completed GWs
  - Only fetched picks from `manager_picks` table
  - Missed official points and transfer costs from `manager_gw_history` table
  - Missed active chips from `manager_chips` table
  - This caused score calculation to default to 0
- **Fix**: Updated `fetchManagerPicks()` in `src/lib/scoreCalculator.ts:75-119`
  - Now fetches from all 3 K-27 tables in parallel:
    - `manager_picks` â†’ team selections (player_id, position, multiplier, is_captain)
    - `manager_gw_history` â†’ official points & transfer costs
    - `manager_chips` â†’ active chip for the GW
  - Returns complete data structure with all required fields
- **Testing**:
  - âœ“ Local: GW16 fixtures show correct scores (44-68, 54-76, etc.)
  - âœ“ Production: All completed GW fixtures display properly
  - âœ“ Build successful with no TypeScript errors
- **Deployment**:
  - Committed as v2.7.1
  - Deployed to production at 08:25 UTC
  - Required empty commit to trigger Railway webhook

### v2.7.0 - K-27: Comprehensive Database Caching (Dec 16, 2025)
**MAJOR FEATURE:** Implemented comprehensive database caching to eliminate redundant FPL API calls
- **Project K-27**: Cache all historical gameweek data in database
  - 100+ fewer FPL API calls per Stats Hub page load
  - All completed GWs served from database (fast, reliable)
  - FPL API only used for live/upcoming GWs
- **New Database Tables** (5 tables, all with proper indexes and unique constraints):
  1. `manager_gw_history` - GW points, ranks, transfers, transfer costs
  2. `manager_picks` - Team selections per GW (15 players with positions, multipliers, captaincy)
  3. `manager_chips` - Chip usage tracking (WC, BB, TC, FH)
  4. `manager_transfers` - Transfer history with player in/out and costs
  5. `pl_fixtures` - All 380 PL fixtures with scores, FDR, kickoff times
- **Migration Scripts** (5 scripts in `src/db/migrations/`):
  - `add_manager_gw_history.sql`
  - `add_manager_picks.sql`
  - `add_manager_chips.sql`
  - `add_manager_transfers.sql`
  - `add_pl_fixtures.sql`
- **Sync Scripts** (5 scripts in `src/scripts/`):
  - `sync-manager-history.ts` - Syncs GW history for all managers in league
  - `sync-manager-picks.ts` - Syncs team selections for completed GWs
  - `sync-manager-chips.ts` - Syncs chip usage from FPL API history
  - `sync-manager-transfers.ts` - Syncs all transfers with costs and timing
  - `sync-pl-fixtures.ts` - Syncs all PL fixtures with upsert logic
- **Migration Runners** (5 runners to execute SQL):
  - `run-manager-history-migration.ts`
  - `run-manager-picks-migration.ts`
  - `run-manager-chips-migration.ts`
  - `run-manager-transfers-migration.ts`
  - `run-pl-fixtures-migration.ts`
- **Verification Scripts** (helper scripts for debugging):
  - `verify-manager-chips.ts`
  - `verify-manager-transfers.ts`
  - `verify-pl-fixtures.ts`
- **NPM Scripts** (added to `package.json`):
  ```bash
  npm run migrate:manager-history
  npm run migrate:manager-picks
  npm run migrate:manager-chips
  npm run migrate:manager-transfers
  npm run migrate:pl-fixtures

  npm run sync:manager-history
  npm run sync:manager-picks
  npm run sync:manager-chips
  npm run sync:manager-transfers
  npm run sync:pl-fixtures
  ```
- **Production Deployment**:
  - All 5 migrations run successfully
  - All data synced for league 804742:
    - manager_gw_history: 320 records (20 managers Ã— 16 GWs)
    - manager_picks: 4,800 records (20 managers Ã— 16 GWs Ã— 15 players)
    - manager_chips: 55 records (19 WC, 16 BB, 11 TC, 9 FH)
    - manager_transfers: 711 records (GW2-16)
    - pl_fixtures: 380 records (160 completed, 220 upcoming)
- **API Updates**:
  - Stats Hub endpoints now use database for completed GWs
  - `scoreCalculator.ts` updated to fetch from database first
  - Fixtures API uses database for chip data
- **Performance Impact**:
  - Stats Hub page: ~100 fewer API calls per load
  - Fixtures page: Instant load for completed GWs
  - Rankings: Database-backed for historical GWs
- **Database Design**:
  - All tables have proper unique constraints to prevent duplicates
  - Comprehensive indexes for query performance
  - ON CONFLICT clauses allow re-running syncs safely
  - Foreign key relationships for data integrity

## ðŸ“Š v2.6.x - Players Tab Database Integration (Dec 2025)

### v2.6.7 - Switch PlayersTab to Use Database Instead of FPL Proxy (Dec 15, 2025)
**DATABASE:** Migrated PlayersTab from temporary FPL proxy to production database
- **Database Setup:**
  - Added missing columns to `players` table:
    - `team_code` (INTEGER) - for jersey image URLs
    - `event_points` (INTEGER) - current gameweek points
    - `cost_change_start` (INTEGER) - price changes since season start
  - Added missing column to `player_gameweek_stats` table:
    - `defensive_contribution` (INTEGER) - defensive stats
  - Updated `playerSync.ts` to populate all new fields from FPL API
- **Code Updates:**
  - Updated `PlayersTab.tsx` to fetch from `/api/players` endpoint instead of `/api/fpl-proxy`
  - Updated all Player interfaces across components to use database field names:
    - `position` (string: 'GKP'/'DEF'/'MID'/'FWD') instead of `element_type` (number: 1/2/3/4)
    - `team_id` instead of `team`
    - Added `team_name`, `team_short` fields
  - Updated `PlayerCell.tsx` to use `position` string directly
  - Updated `PlayersTable.tsx` teamMap to use `team_id` for lookups
- **Sync Process:**
  - Running full player sync (760 players + gameweek history)
  - Database will contain complete player season and per-gameweek stats
- **Result:** Players tab now loads from database instead of making external API calls
  - âœ“ Faster load times from local database
  - âœ“ No dependency on FPL API availability
  - âœ“ Consistent data structure with rest of app
  - âœ“ Build successful with no TypeScript errors

### v2.6.6 - Fix Players Tab with FPL API Proxy (Dec 15, 2025)
**FIX:** Created server-side proxy to bypass CORS restrictions
- Created `/api/fpl-proxy/route.ts` to fetch from FPL API server-side
- Reverted all Player interfaces back to FPL API structure
- Temporary solution until database is populated

### v2.6.5 - Attempt Database API for Players Tab (Dec 15, 2025)
**ATTEMPT:** Tried switching to database API (failed - tables didn't exist yet)
- Updated PlayersTab to use `/api/players` endpoint
- Updated interfaces to match database structure
- Failed with "relation 'players' does not exist" error

### v2.6.4 - Improve Error Handling for Players Tab (Dec 15, 2025)
**UX:** Enhanced error display with retry functionality
- Added detailed error messages with HTTP status codes
- Added retry button for failed fetches
- Styled error states in PlayersTab.module.css

### v2.6.3 - Integrate New PlayersTab into Stats Section (Dec 15, 2025)
**INTEGRATION:** Connected new PlayersTab component to app
- Updated StatsHub.tsx import from relative to absolute path
- Changed from `./Players/PlayersTab` to `@/components/Players/PlayersTab`
- Build successful, component now active in Stats section

### v2.6.2 - Simplify Version Numbering (Dec 15, 2025)
**PROCESS:** Simplified versioning from "2.6.0-alpha.1" to "2.6.2"
- Removed alpha/beta suffixes for cleaner version numbers
- Updated package.json version field

---
## ðŸŽ¯ v2.6.0-alpha - Players Tab Foundation (Dec 2025)

### v2.6.0-alpha.2 - Add All Stats Columns with Compact/All Toggle (Dec 15, 2025)
**FEATURE:** Expanded player statistics with view mode toggle
- **View Modes:**
  - Compact view: Â£, TSB%, Pts, Form (4 essential columns)
  - All Stats view: 25 comprehensive columns across all categories
- **Categories:**
  - Basic: Price, ownership, points, form
  - Appearances: Starts, minutes
  - Attacking: Goals, assists, expected goals (xG), expected assists (xA), xGI
  - Defensive: Clean sheets, goals conceded, saves
  - Bonus: BPS, bonus points
  - Value: Transfers, price changes
- **Implementation:**
  - Created `columns.ts` with column definitions and formatters
  - Added format functions for Â£, %, xG, xA, xGI, price changes
  - Styled toggle buttons with active state
  - Dynamic column rendering based on viewMode
- **Files Added:**
  - `src/components/Players/columns.ts` - Column definitions with formatters
- **Files Modified:**
  - `PlayersTab.tsx` - Add viewMode state and toggle UI
  - `PlayersTable.tsx` - Accept viewMode, render dynamic columns
  - `PlayerRow.tsx` - Render cells based on columns config
  - `PlayersTab.module.css` - Add toggle styling
- **Next Steps:** K-26.3 (filtering), K-26.4 (sorting/search), K-26.5 (player modal)

### v2.6.0-alpha.1 - Add Players Tab Foundation (Dec 15, 2025)
**FOUNDATION:** Initial Players tab implementation in Stats Hub
- Created new Players sub-tab in Stats section
- Basic player table structure with jersey images
- Player info displays: name, position, team
- Initial stats columns setup
- Layout foundation for upcoming features
- **Components Added:**
  - `PlayersTab.tsx` - Main container component
  - `PlayersTable.tsx` - Table component
  - `PlayerRow.tsx` - Row component
  - `PlayerCell.tsx` - Player info cell
  - `PlayersTab.module.css` - Styling
- **Integration:** Connected to Stats Hub navigation

---

## ðŸŽ® v2.5.x - Player Features & UI Polish (Dec 2025)

### v2.5.29 - Make Player Card Name and Points/Fixture Bars Equal Height (Dec 15, 2025)
**UX:** Consistent heights for player card sections
- Made name bar and points/fixture bars equal height
- Improved visual balance in player cards
- Better proportions across all card elements

### v2.5.28 - Fix Chip Badge Icon Alignment (Dec 15, 2025)
**FIX:** Proper fix for chip badge icon alignment
- Corrected icon vertical alignment in chip badges
- Ensured consistent spacing
- Clean visual presentation

### v2.5.27 - Reduce Player Card Box Height for Better Proportions (Dec 15, 2025)
**UX:** Improved player card proportions
- Reduced box height for better visual balance
- More compact, professional appearance
- Optimized spacing ratios

### v2.5.26 - Fix Player Card Size Consistency (Dec 15, 2025)
**FIX:** Fixed player card size consistency for points and fixture boxes
- Ensured equal sizing across all cards
- Consistent layout regardless of content
- Better grid alignment

### v2.5.25 - Fix Icon Alignment in Chip Badges (Dec 15, 2025)
**FIX:** Icon alignment in chip badges
- Corrected vertical alignment issues
- Improved spacing between icon and text
- Cleaner badge presentation

### v2.5.24 - Replace Final Two Emojis in Stats Hub (Dec 15, 2025)
**UI:** Replaced final two emojis in Stats Hub with Lucide icons
- Completed emoji replacement project
- All UI now uses consistent Lucide icons
- Professional, modern icon system throughout

### v2.5.23 - Replace Trophy Icon with Cleaner Shirt Icon (Dec 15, 2025)
**UI:** Replace Trophy icon with cleaner Shirt icon in navigation
- Changed to more appropriate icon for player stats
- Better visual consistency
- Cleaner navigation appearance

### v2.5.22 - Replace Remaining Emojis in Stats Hub (Dec 15, 2025)
**UI:** Replace remaining emojis in Stats Hub with Lucide icons
- Continued systematic replacement of emojis
- Improved visual consistency
- Professional icon system

### v2.5.21 - Replace Emojis with Color-Matched Lucide Icons (Dec 15, 2025)
**UI:** Replace emojis with color-matched Lucide icons
- Migrated from emojis to professional icon library
- Color-matched icons to existing theme
- Better cross-platform consistency
- Improved accessibility

### v2.5.20 - Fix LiveMatchModal Player Colors (Dec 15, 2025)
**FIX:** Use hasPlayed instead of points for player status colors
- More accurate player status indication
- Fixed edge cases where player played but scored 0
- Improved visual feedback

### v2.5.19 - Final Color Fixes (Dec 15, 2025)
**FIX:** Final color fixes for name bar and differential players
- Corrected name bar colors
- Fixed differential player color states
- Polished visual presentation

### v2.5.18 - Fix Differential Players Colors (Dec 15, 2025)
**FIX:** Fixed differential players colors - include current GW minutes
- Improved color logic for differential players
- Accounts for current gameweek minutes played
- More accurate status indication

### v2.5.17 - Show Fixture Info for Players Who Haven't Played (Dec 15, 2025)
**FEATURE:** Show fixture info for players who haven't played yet
- Display upcoming fixture for players yet to play
- Better information density
- Improved planning capability

### v2.5.16 - Add Script to Sync All Players with Defensive Contribution (Dec 15, 2025)
**TOOLS:** Add script to sync all players with defensive contribution data
- Created bulk sync script for DEFCON data
- Populates defensive_contribution for all players
- Ensures complete historical data
- **Files Added:**
  - `src/scripts/sync-all-players-defcon.ts`

### v2.5.15 - Fix Defensive Contribution Display (Dec 15, 2025)
**FIX:** Always show Defensive Contribution for DEF/MID positions
- Fixed display logic to always show DC for defenders and midfielders
- Consistent stat presentation
- Proper position-based filtering

### v2.5.14 - Dynamic Stats When Navigating Gameweeks (Dec 15, 2025)
**FEATURE:** Dynamic stats when navigating gameweeks in My Team
- Stats update when changing gameweek
- Real-time data loading
- Accurate historical view

### v2.5.13 - Fix Player Status Colors (Dec 15, 2025)
**FIX:** Use minutes instead of points for player status colors
- More accurate status indication
- Fixes edge case of 0-point performances
- Better visual feedback

### v2.5.12 - Add Defensive Contribution Points (DEFCON) (Dec 15, 2025)
**FEATURE:** Defensive contribution points now calculated and displayed
- **Database:** Added `defensive_contribution` column to `player_gameweek_stats` table
- **Sync:** Updated `playerSync.ts` to sync defensive contribution from FPL API
- **Calculation:**
  - Defenders (pos 2): +2 pts per 10 DC (Math.floor(DC / 10) * 2)
  - Midfielders (pos 3): +2 pts per 12 DC (Math.floor(DC / 12) * 2)
  - GKP and FWD: no DC points
- **Display:** Added to PlayerModal stats display (DEF/MID only)
- **Migration:** Created migration script `add-defensive-contribution.ts`
- **Verification:** Tested with Senesi GW15: 11 DC = 2 pts âœ“ (Total: 8 pts)
- **Files Added:**
  - `src/db/migrations/add_defensive_contribution.sql`
  - `src/scripts/add-defensive-contribution.ts`
  - `src/scripts/sync-player-defcon.ts`
- **Files Modified:**
  - `src/lib/sync/playerSync.ts` - Added DC to INSERT/UPDATE
  - `src/components/PitchView/PlayerModal.tsx` - DC calculation & display
  - `package.json` (v2.5.12)

### v2.5.11 - Complete Player Modal with FPL-Style Points Breakdown (Dec 15, 2025)
**FEATURE:** Full points breakdown like official FPL app
- **Points Calculation:** Complete FPL points rules implementation
  - Minutes: 1-59 min = 1 pt, 60+ min = 2 pts
  - Goals: GKP/DEF = 6, MID = 5, FWD = 4
  - Assists: 3 pts each
  - Clean sheets: GKP/DEF = 4, MID = 1
  - Goals conceded: -1 per 2 goals (GKP/DEF only)
  - Saves: +1 per 3 saves (GKP only)
  - Penalties saved: 5 pts, Penalties missed: -2 pts
  - Yellow card: -1, Red card: -3
  - Own goals: -2 pts each
  - Bonus: 1:1 points
- **Display:**
  - Points shown for each stat (e.g., "Assists: 2 â†’ +6 pts")
  - Only non-zero stats shown (cleaner, FPL-style)
  - BPS shown as "(info only)"
  - Captain multiplier in total (e.g., "11 Ã—2 = 22")
  - Grid layout for label/value/points columns
- **Missing Stats Added:** own_goals, penalties_saved, penalties_missed
- **Verification:** Saka GW16: 90 min + 2 assists + 3 bonus = 11 pts âœ“

### v2.5.10 - Fix PlayerModal (Dec 15, 2025)
**FIX:** Remove external API call, copy working pattern
- Fixed PlayerModal to use existing database pattern
- Removed external FPL API dependency
- Consistent with other modals

### v2.5.9 - Add Mandatory Testing Section to CLAUDE.md (Dec 15, 2025)
**DOCS:** Added mandatory testing guidelines to CLAUDE.md
- Defined testing requirements for all changes
- Build verification steps
- Quality assurance process

### v2.5.8 - Copy Working PlayerDetailModal Pattern to PlayerModal (Dec 15, 2025)
**REFACTOR:** Standardized modal pattern across codebase
- Applied working pattern from PlayerDetailModal
- Consistent architecture
- Reusable modal structure

### v2.5.7 - Update Version Number for Debug Logging (Dec 15, 2025)
**DEBUG:** Version bump for debug logging
- Incremented version to track debug changes
- Better version tracking

### v2.5.6-debug - Add Debug Logging to PlayerModal (Dec 15, 2025)
**DEBUG:** Added debug logging to PlayerModal
- Temporary debug version
- Investigation of modal issues
- Diagnostic logging

### v2.5.6 - Fix My Team Modal (Dec 15, 2025)
**FIX:** Use working /api/players endpoint
- Fixed My Team modal data fetching
- Switched to reliable API endpoint
- Improved reliability

### v2.5.5 - Fix K-23 Critical Bugs + Database Migration (Dec 14, 2025)
**FIX:** Critical bug fixes and database migration
- Resolved K-23 critical issues
- Database schema updates
- Stability improvements

### v2.5.4 - Fix TypeScript Error in PlayerDetailModal (Dec 14, 2025)
**FIX:** TypeScript compilation error
- Fixed type errors in PlayerDetailModal
- Clean build
- Type safety maintained

### v2.5.3 - Add Missing lucide-react Dependency (Dec 14, 2025)
**FIX:** Added missing lucide-react package
- Installed lucide-react dependency
- Fixed import errors
- Enabled icon usage

### v2.5.2 - Fix K-21c - Connect PlayerModal to Backend API (Dec 14, 2025)
**FIX:** Connect PlayerModal to backend API
- Integrated PlayerModal with database API
- Real data fetching
- Proper data flow

### v2.5.1 - Bump Version for Player Detail Modal Feature (Dec 14, 2025)
**VERSION:** Version bump for Player Detail Modal feature
- Incremented to v2.5.1
- Prepared for feature release

### v2.5.0 K-23d - Add Player Detail Modal (Dec 14, 2025)
**FEATURE:** Player Detail Modal implementation
- Full player detail view
- Stats breakdown
- Interactive modal component

### v2.5.0 (K-23c-v2) - Fix Players List UI - Styling & All Stats (Dec 14, 2025)
**UI:** Fixed Players List UI styling and all stats display
- Improved styling
- Complete stats display
- Better UX

### v2.5.0 (K-23c) - Add Players List UI to Stats Hub (Dec 14, 2025)
**FEATURE:** Players List UI in Stats Hub
- Added player list interface
- Integrated into Stats Hub
- Foundation for player browsing

### v2.5.0 (K-23b) - Add Players API Endpoints (Dec 14, 2025)
**API:** Players API endpoints implementation
- **Endpoints:**
  - GET /api/players - Query players with filters
  - GET /api/players/[id] - Get individual player
  - GET /api/players/[id]/gameweek/[gw] - Get player gameweek stats
- **Features:**
  - Filtering by position, team, price range
  - Sorting by any stat (points, form, price, etc.)
  - Search by name
  - Pagination support
- **Files Added:**
  - `src/app/api/players/route.ts`
  - `src/app/api/players/[id]/route.ts`
  - `src/app/api/players/[id]/gameweek/[gw]/route.ts`

### v2.5.0 - Add Players Database Schema + Sync Job (K-23a) (Dec 14, 2025)
**DATABASE:** Complete player database infrastructure
- **Schema Changes:**
  - Created `players` table (~760 rows) with comprehensive stats
  - Created `player_gameweek_stats` table for per-GW history
  - Created `teams` table (20 teams) for reference data
  - Added appropriate indexes for performance
- **Sync Implementation:**
  - Created `playerSync.ts` with `syncPlayers()` function
  - Syncs all players from FPL bootstrap API
  - Syncs team data (strength, attack/defence ratings)
  - Created `syncPlayerHistory(playerId)` for per-GW data
  - Comprehensive logging and error handling
- **API Endpoints:**
  - POST /api/admin/sync/players - triggers player sync
  - Returns success status, count, and any errors
- **Data Structure:**
  - Players: ID, name, team, position, price, ownership stats
  - Stats: Total points, form, minutes, goals, assists, xG, xA
  - Defensive: Clean sheets, goals conceded, xGC
  - Bonus: BPS, ICT index (influence, creativity, threat)
  - Status: Injury status, availability, news
- **Testing:**
  - Added `test-player-sync.ts` script
  - Verified 760 players synced successfully
  - Verified 20 teams synced successfully
  - Verified data accuracy (top scorers, prices, positions)
- **Files Added:**
  - `src/db/migrations/add_players_tables.sql`
  - `src/lib/sync/playerSync.ts`
  - `src/app/api/admin/sync/players/route.ts`
  - `src/scripts/test-player-sync.ts`
- **Next Phase:** Ready for K-23b (API endpoints for querying player data)

---

