# FPL H2H Analytics - Complete Version History

**Project Start:** October 23, 2024
**Total Releases:** 249+ versions
**Current Version:** v2.6.7 (December 15, 2025)

---


## ðŸŽ‰ v2.0.x - Multi-League Support (Dec 2025) - **MAJOR MILESTONE**

### v2.0.20 - Odd-Numbered League Support + Cleanup (Dec 9, 2025)
**FEATURE:** Support for H2H leagues with odd number of teams (AVERAGE opponent)
- Added: AVERAGE entries stored with entry_id = -1 in database
- Added: Matches vs AVERAGE now captured and stored in h2h_matches table
- Added: AVERAGE row appears in League Rankings (italic, 60% opacity styling)
- Fixed: No longer skips AVERAGE as "corrupted data" from FPL API
- Backend: Updated `/api/league/[id]/route.ts` to handle null entry_id (AVERAGE)
- Frontend: Updated LeagueTab to detect and style AVERAGE entries
- Test League: 754307 (Powerleague 2025, 31 teams)
- Also: Documented admin deployment exception for `/admin` and `/api/admin` routes
- Also: Activity toggle (Managers/Requests) with dynamic data filtering in admin panel
- Note: Package version was 2.0.19, now properly bumped to 2.0.20
- Files: `src/app/api/league/[id]/route.ts`, `src/components/Dashboard/LeagueTab.tsx`, `DEPLOYMENT.md`, `CLAUDE.md`

### v2.0.18 - Update Documentation to v2.0.18 (Dec 8, 2025)
**DOCUMENTATION:** Updated all version documentation to reflect current state
- Updated: VERSION_HISTORY_COMPLETE.md with versions 2.0.13-2.0.17
- Updated: README.md current version from v1.26.6 to v2.0.18
- Updated: README.md changelog reference to VERSION_HISTORY_COMPLETE.md
- Added: Complete documentation of admin panel debug and fix process
- Context: Versions 2.0.13-2.0.17 fixed admin panel showing zeros issue
- Files: `VERSION_HISTORY_COMPLETE.md`, `README.md`

### v2.0.17 - Clean Up Debug Endpoints (Dec 8, 2025)
**CLEANUP:** Removed temporary debug files after fixing admin panel
- Removed: `/api/debug/db-info` endpoint (temporary debugging)
- Removed: `/api/debug/table-info` endpoint (temporary debugging)
- Removed: `test-queries.js` script (temporary debugging)
- Status: Admin panel now working correctly with real analytics data
- Note: Debug endpoints were only needed to diagnose the build-time database connection issue
- Files: Deleted `src/app/api/debug/*`, `test-queries.js`

### v2.0.16 - Fix Admin Panel - Add force-dynamic (Dec 8, 2025)
**CRITICAL FIX:** Admin panel now displays real analytics data instead of zeros
- Problem: Admin panel showing all zeros despite database having 23,958 records
- Root Cause: Next.js tried to prerender admin routes during build, but `postgres.railway.internal` hostname only available at runtime
- Error: `getaddrinfo ENOTFOUND postgres.railway.internal`
- Fixed: Added `export const dynamic = 'force-dynamic'` to admin API routes
- Routes: `/api/admin/stats/route.ts`, `/api/admin/leagues/route.ts`
- Impact: Routes now execute only at request time when database connection available
- Result: Admin panel displays correct data (23,958 requests, 385 users, 107 leagues)
- Files: `api/admin/stats/route.ts`, `api/admin/leagues/route.ts`

### v2.0.15 - Add Error Details to Admin Stats Response (Dec 8, 2025)
**DEBUG:** Added detailed error information to identify failing queries
- Added: Return error message in JSON response
- Added: Return error stack trace in JSON response
- Purpose: Identify which specific query was failing in admin stats
- Result: Revealed "getaddrinfo ENOTFOUND postgres.railway.internal" error during build
- Files: `api/admin/stats/route.ts`

### v2.0.14 - Add Table Structure Debug Endpoint (Dec 8, 2025)
**DEBUG:** Created endpoint to verify database table structure
- Added: `/api/debug/table-info` endpoint
- Checks: Table existence via information_schema.columns
- Checks: Column names and data types
- Tests: Simple COUNT query and sample row retrieval
- Result: Confirmed analytics_requests table exists with 23,912 rows
- Result: Confirmed all expected columns present (id, league_id, endpoint, method, timestamp, user_hash, response_time_ms, status_code, selected_team_id)
- Files: `src/app/api/debug/table-info/route.ts`

### v2.0.13 - Add Debug Endpoint for Database Connection (Dec 8, 2025)
**DEBUG:** Created endpoint to check production DATABASE_URL
- Added: `/api/debug/db-info` endpoint
- Shows: Masked DATABASE_URL being used by production
- Shows: Analytics requests count and last record timestamp
- Purpose: Verify which database production is actually connecting to
- Result: Confirmed production uses `postgres.railway.internal:5432`
- Result: Confirmed database has 23,895 rows of analytics data
- Files: `src/app/api/debug/db-info/route.ts`

### v2.0.12 - Add Enhanced Analytics Debug Logging (Dec 5, 2025)
**DEBUG:** Added detailed logging to diagnose analytics tracking issue
- Added: Log track URL construction (protocol, host)
- Added: Log fetch response status
- Added: Log parsed response JSON
- Added: More detailed error logging with URL
- Purpose: Diagnose why analytics not being tracked since Friday
- Files: `src/middleware.ts`

### v2.0.11 - Fix Analytics Tracking (Dec 5, 2025)
**CRITICAL BUG FIX:** Analytics now saving to database - admin stats will populate
- Fixed: Analytics tracking was failing silently trying to write to non-existent analytics_leagues table
- Fixed: Removed all references to analytics_leagues from analytics.ts
- Changed: trackRequest() now only writes to analytics_requests table
- Changed: updateLeagueMetadata() is now a no-op (metadata computed on-demand)
- Changed: aggregateDailyStats() no longer updates analytics_leagues
- Impact: Analytics will now be tracked and saved to database
- Impact: Admin dashboard will show real stats after this deployment
- Files: `lib/analytics.ts`

### v2.0.10 - Fix Admin Dashboard Stats API (Dec 5, 2025)
**CRITICAL BUG FIX:** Fixed admin dashboard showing "Cannot read properties of undefined"
- Fixed: Admin stats API was querying non-existent `analytics_leagues` table
- Fixed: Error handler was missing `uniqueManagers` field in fallback response
- Changed: Rewrote queries to use only `analytics_requests` table
- Changed: Aggregate league stats directly from analytics_requests
- Added: Proper integer casting for all numeric fields
- Impact: Admin dashboard now loads without client-side errors
- Impact: Stats display correctly even when database is empty
- Files: `api/admin/stats/route.ts`

### v2.0.9 - Fix Admin Panel Sort Handler (Dec 5, 2025)
**BUG FIX:** Fixed client-side error in admin panel sort logic
- Fixed: handleSort trying to access leagues[0] when array is empty
- Fixed: Changed to check field name instead of runtime type checking
- Changed: Use predefined list of numeric fields instead of leagues[0]?.[field]
- Impact: Admin panel no longer crashes on initial load
- Files: `app/admin/leagues/page.tsx:51-63`

### v2.0.8 - Fix Admin Panel Type Casting (Dec 5, 2025)
**BUG FIX:** Fixed client-side error in admin panel caused by type mismatch
- Fixed: Admin panel showing "client-side exception has occurred" error
- Fixed: PostgreSQL COUNT() returns bigint (string), frontend expects number
- Added: Explicit ::integer casts for all numeric fields in query
- Fields cast: league_id, team_count, total_requests, unique_users, unique_managers
- Files: `api/admin/leagues/route.ts`

### v2.0.7 - Fix Admin Panel (Dec 5, 2025)
**BUG FIX:** Admin panel now works - fixed missing league_metadata table error
- Fixed: Admin panel `/admin/leagues` was broken - returning 500 error
- Fixed: Rewrote query to use existing tables instead of non-existent `league_metadata`
- Changed: Now uses CTEs to aggregate data from `analytics_requests` and `h2h_matches`
- Changed: League names now show as "League {id}" (metadata table didn't exist)
- Data: Total requests, unique users, unique managers from analytics_requests
- Data: Team count from h2h_matches
- Files: `api/admin/leagues/route.ts`

### v2.0.6 - Fix Gameweek Stats Showing ALL Leagues (Dec 5, 2025)
**CRITICAL BUG FIX:** Gameweek stats now correctly filtered by current league only
- Fixed: Gameweek stats (Captain Picks, Chips, Hits, Winners, Top Performers) were showing data from ALL leagues in database
- Fixed: `fetchManagers` function now filters by leagueId using EXISTS subquery
- Fixed: SQL query now joins h2h_matches to get only managers in selected league
- Impact: Captain Picks - now shows only captains from current league managers
- Impact: Chips Played - now shows only chips from current league managers
- Impact: Hits Taken - now shows only hits from current league managers
- Impact: Gameweek Winners - now shows only highest/lowest scores from current league
- Impact: Top Performers - now shows only players owned by current league managers
- Files: `api/league/[id]/stats/gameweek/[gw]/route.ts:313-326`

### v2.0.5 - Fix Season Stats Showing Multiple Leagues (Dec 5, 2025)
**CRITICAL BUG FIX:** Season stats now correctly filtered by current league only
- Fixed: Season stats were aggregating data across ALL leagues user is in
- Fixed: Player API now requires and filters by leagueId parameter
- Fixed: SQL query now includes `WHERE league_id = $2` filter
- Updated: Dashboard passes leagueId when fetching player data
- Impact: Highest Score, Lowest Score, Biggest Win, Biggest Loss now league-specific
- Impact: Match history, chips played, and all stats now scoped to current league
- Files: `api/player/[id]/route.ts`, `dashboard/page.tsx`

### v2.0.4 - Add Contact Footer to Settings (Dec 5, 2025)
**FEATURE:** Added contact information footer to Settings page
- Added: Contact footer section at bottom of Settings page
- Content: "Found a bug? Have feedback?" with Reddit and X links
- Link: Reddit u/gregleo (https://reddit.com/u/gregleo)
- Link: X @greglienart (https://x.com/greglienart)
- Styling: Subtle muted colors, small text, center aligned
- UX: Links open in new tab with proper security attributes
- Visual: Separated from content with border and extra spacing
- Files: `SettingsTab.tsx`, `SettingsTab.module.css`

### v2.0.3 - My Leagues UI Polish (Dec 5, 2025)
**UI IMPROVEMENT:** My Leagues section now visually matches Settings page theme
- Updated: My Leagues CSS completely rewritten to match Settings page styling
- Visual: Green theme matching action buttons (rgba(0, 255, 135, ...))
- Visual: Title now uppercase with letter-spacing like other section titles
- Visual: League items styled as cards with proper spacing and borders
- Visual: Current league has green border matching app accent color
- Visual: Hover effects with translateY(-2px) matching action buttons
- Visual: Add button styled consistently with primary actions
- Consistency: All colors changed from CSS variables to explicit rgba values
- File: `/src/components/Settings/MyLeagues.module.css` (244 lines rewritten)

### v2.0.2 - Remember Team Selection Per League (Dec 5, 2025)
**UX IMPROVEMENT:** App now remembers which team you are in each league
- Fixed: Saved leagues now store team info (myTeamId, myTeamName, myManagerName)
- Feature: First time switching to a league â†’ team selection required
- Feature: Subsequent switches â†’ instant switch, no team re-selection
- Smart: Auto-updates team info whenever you're in Settings
- Storage: savedLeagues now includes `{id, name, myTeamId, myTeamName, myManagerName}`
- UX: Much faster league switching for frequently used leagues

### v2.0.1 - Fix League Switching Flow (Dec 5, 2025)
**BUG FIX:** Fixed league switching to include team selection step
- Fixed: Clicking a saved league now redirects to team selection page
- Fixed: No more "Team not found in league" error
- Fixed: No more false error alert when switch succeeds
- Flow: Click league â†’ Select your team â†’ Dashboard loads
- Previous issue: Tried to auto-match team, failed if names didn't match
- Uses same team selection flow as "Change Team" button

### v2.0.0 - My Leagues: Save & Switch Between Multiple Leagues (Dec 5, 2025)
**MAJOR FEATURE:** Multi-league support - manage up to 5 leagues from Settings
- Added: "My Leagues" section in Settings page
- Feature: Save up to 5 leagues with names and IDs in localStorage
- Feature: Current league highlighted with green border and checkmark
- Feature: Click any league to switch (reloads dashboard with new league)
- Feature: Remove leagues with confirmation (cannot remove current league)
- Feature: Add new leagues by entering league ID (fetches name automatically)
- Storage: Uses new 'savedLeagues' localStorage key (array of {id, name})
- UX: Shows max limit message when 5 leagues saved
- Files: `/src/components/Settings/MyLeagues.tsx` + CSS module

---

